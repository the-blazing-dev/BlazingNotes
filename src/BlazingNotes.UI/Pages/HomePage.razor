@page "/"
@using BlazingNotes.Logic.Services
@inject IState<AppState> AppState

<BzPageTitle>Home</BzPageTitle>

<MudStack Spacing="6">

    <MudCard Outlined Class="mx-auto bz-border-color-primary">
        @* less top margin because the outlined TextField has some additional spacing *@
        <MudCardContent Class="px-3 pb-3 pt-2 note-card-text-width">
            <MudStack Spacing="2" Class="">
                <MudTextField T="string"
                              @bind-Value="_input"
                              AutoGrow="true"
                              Lines="3"
                              MaxLines="10"
                              Immediate="true"
                              OnKeyUp="HandleKeyUp"
                              AutoFocus="true"
                              Variant="Variant.Outlined"
                              TextUpdateSuppression="false"
                              Label="Suchen oder Erstellen"
                              Class="mb-0"
                              Placeholder="Hier kannst du nach bestehenden Notizen suchen und gleichzeitig neue Notizen erstellen"/>
                <MudStack Row Spacing="2">
                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Add"
                               FullWidth
                               Disabled="!_input.HasContent()"
                               OnClick="HandleCreate">
                        Create new note
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>

    @{
        if (NoteSearcher.IsSearchTermLongEnough(_input))
        {
            var searchable = AppState.Value.GetSearchableNotes().OrderByDescending(x => x.CreatedAt).ToList();
            var (_, query, matches) = NoteSearcher.Search(searchable, _input);
            var matchesTake = matches.Take(10).ToList();
            // ShowNoteCount=false because we show only 10 preview items
            <NoteCardList Headline="Suchergebnisse"
                          Notes="matchesTake"
                          SearchQuery="@query"
                          ShowNoteCount="false">
                <AfterLastCardContent>
                    @if (matches.Count > matchesTake.Count)
                    {
                        var href = SearchPage.GetUrl(_input);
                        <MudButton Href="@href"
                                   Variant="Variant.Outlined"
                                   EndIcon="@Icons.Material.Filled.ArrowForward"
                                   Class="note-card-text-width">
                            Continue search
                        </MudButton>
                    }
                </AfterLastCardContent>
            </NoteCardList>
        }
        else
        {
            @* ShowNoteCount=false because we show only 10 preview items *@
            <NoteCardList Headline="Zuletzt erstellt"
                          Notes="AppState.Value.GetHomePageNotes()"
                          ShowNoteCount="false"/>
        }
    }

</MudStack>

@code {

    string _input = "";

    private void HandleCreate()
    {
        Dispatch(new NoteActions.CreateNoteRequestAction(_input));
        _input = "";
    }

    private void HandleKeyUp(KeyboardEventArgs args)
    {
        if (args.CtrlKey && args.Key == "Enter")
        {
            HandleCreate();
        }
    }

}